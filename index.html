<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>美容室ODA 予約</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: sans-serif; padding: 20px; background: #fafafa; }
    .container { background: white; padding: 20px; border-radius: 8px; max-width: 500px; margin: 0 auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h4 { color: #333; font-weight: bold; text-align: center; margin-bottom: 20px; }
    label { font-weight: bold; color: #555; margin-top: 15px; display: block;}
    .badge-required { background: #ff4d4d; color: white; padding: 3px 6px; border-radius: 4px; font-size: 12px; margin-left: 5px; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; margin-top: 5px; box-sizing: border-box; }
    button#submitBtn { width: 100%; padding: 15px; background: #00B900; color: white; border: none; border-radius: 4px; font-size: 18px; font-weight: bold; margin-top: 30px; }
    
    /* カレンダー */
    .date-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
    .date-cell { padding: 10px 0; text-align: center; border: 1px solid #eee; border-radius: 5px; cursor: pointer; }
    .date-cell.disabled { background: #f9f9f9; color: #ccc; pointer-events: none; }
    .date-cell.selected { background: #00B900; color: white; border-color: #00B900; }
    .date-cell:hover:not(.disabled) { background: #f0f0f0; }
    
    #loading { text-align: center; padding: 20px; display: none; }
    .spinner-border { width: 3rem; height: 3rem; color: #00B900; }
  </style>
</head>
<body>
  <div class="container">
    
    <form id="bookingForm">
      <label>お名前<span class="badge-required">必須</span></label>
      <input type="text" name="name" placeholder="例：BEAUTY SALON ODA" required>

      <label>メニュー<span class="badge-required">必須</span></label>
      <select name="menu" id="menuSelect" required onchange="resetTime()">
        <option value="">▼メニューを選択してください</option>
        <option value="カット" data-slots="2">カット</option>
        <option value="カラー＋カット" data-slots="5">カラー＋カット</option>
        <option value="パーマ＋カット" data-slots="5">パーマ＋カット</option>
        <option value="トリートメント" data-slots="2">トリートメント</option>
        <option value="縮毛矯正＋カット" data-slots="6">縮毛矯正＋カット</option>
        <option value="まつ毛パーマ" data-slots="2">まつ毛パーマ</option>
        <option value="まつげエクステ" data-slots="3">まつげエクステ</option>
      </select>

      <label>予約日時を選択<span class="badge-required">必須</span></label>
      <div style="text-align:center; margin-bottom:10px;">
        <button type="button" class="btn btn-sm btn-light" onclick="changeWeek(-1)">＜ 前の週</button>
        <span id="monthDisplay" style="font-weight:bold; margin:0 10px;"></span>
        <button type="button" class="btn btn-sm btn-light" onclick="changeWeek(1)">次の週 ＞</button>
      </div>
      <div id="calendarArea" class="date-grid"></div>
      <input type="hidden" name="date" id="dateInput">

      <div id="timeArea" style="display:none;">
        <label>開始時間<span class="badge-required">必須</span></label>
        <select name="time" id="timeSelect">
          <option value="">▼時間を選択</option>
        </select>
      </div>

      <label>お問い合わせ</label>
      <input type="text" name="note" placeholder="ご要望など">

      <button type="button" id="submitBtn" onclick="submitBooking()">予約を確定する</button>
    </form>

    <div id="loading">
      <div class="spinner-border" role="status"></div>
      <p>送信中...</p>
    </div>
  </div>

  <script>
    // =================================================================
    // ★ここにGASのURLを貼り付けてください（末尾の /exec まで）
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbw_9xLdOlVs2edcQgLI3LiWCZK2RAr2aBONhu4lu72KT_Lj1U1R0Ek6CfCnrUAzs1eA/exec";
    // =================================================================

    let currentStartDate = new Date();
    let bookedData = {};

    window.onload = function() {
      renderCalendar();
      fetchAvailability();
    };

    function fetchAvailability() {
      // GitHubからGASに通信
      fetch(GAS_API_URL + "?q=get_slots")
        .then(response => response.json())
        .then(data => {
            bookedData = {};
            data.forEach(d => {
               let parts = d.split(" ");
               if(parts.length >= 2) {
                 let key = parts[0]; 
                 if(!bookedData[key]) bookedData[key] = new Set();
                 bookedData[key].add(parts[1]);
               }
            });
            let date = document.getElementById('dateInput').value;
            if(date) updateTimeSlots(date);
        })
        .catch(error => {
            console.error('Error:', error);
            // alertは出さずに静かに失敗（ユーザーを驚かせない）
        });
    }

    function renderCalendar() {
      const container = document.getElementById('calendarArea');
      container.innerHTML = "";
      const days = ['日','月','火','水','木','金','土'];
      
      days.forEach(d => {
        let div = document.createElement('div');
        div.innerText = d;
        div.style.fontSize = "12px";
        div.style.fontWeight = "bold";
        div.style.textAlign = "center";
        if(d==='日') div.style.color='red';
        if(d==='土') div.style.color='blue';
        container.appendChild(div);
      });

      let d = new Date(currentStartDate);
      document.getElementById('monthDisplay').innerText = d.getFullYear() + "年" + (d.getMonth()+1) + "月";
      
      for(let i=0; i<14; i++) {
        let cell = document.createElement('div');
        cell.className = 'date-cell';
        let y = d.getFullYear();
        let m = d.getMonth()+1;
        let day = d.getDate();
        let w = d.getDay();
        
        cell.innerHTML = day + "<br><span style='font-size:10px'>○</span>";
        let dateStr = y + '/' + ('0'+m).slice(-2) + '/' + ('0'+day).slice(-2);
        
        if(w === 1 || (w === 2 && day >= 15 && day <= 21)) {
           cell.innerHTML = day + "<br><span style='font-size:10px'>休</span>";
           cell.classList.add('disabled');
           cell.style.color = "red";
        }
        
        cell.onclick = function() {
           document.querySelectorAll('.date-cell').forEach(c => c.classList.remove('selected'));
           cell.classList.add('selected');
           document.getElementById('dateInput').value = dateStr;
           updateTimeSlots(dateStr);
        };
        container.appendChild(cell);
        d.setDate(d.getDate()+1);
      }
    }

    function changeWeek(n) {
      currentStartDate.setDate(currentStartDate.getDate() + (n*7));
      renderCalendar();
    }

    function resetTime() {
      document.getElementById('timeArea').style.display = 'none';
      document.getElementById('timeSelect').innerHTML = '<option value="">▼時間を選択</option>';
      let date = document.getElementById('dateInput').value;
      if(date) updateTimeSlots(date);
    }

    function updateTimeSlots(dateStr) {
      let menu = document.getElementById('menuSelect');
      if(!menu.value) return;
      
      document.getElementById('timeArea').style.display = 'block';
      let select = document.getElementById('timeSelect');
      select.innerHTML = "";
      
      let slotsNeeded = parseInt(menu.options[menu.selectedIndex].getAttribute('data-slots'));
      let times = ["9:00","9:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30","18:00","18:30","19:00"];
      
      let bookedSet = bookedData[dateStr.replace(/\/0/g, '/')] || new Set();

      times.forEach(t => {
         let opt = document.createElement('option');
         opt.value = t;
         opt.text = t;
         
         let isBlocked = false;
         let checkTime = t;
         for(let i=0; i<slotsNeeded; i++) {
            if(bookedSet.has(checkTime) || bookedSet.has("休")) {
               isBlocked = true; break;
            }
            checkTime = add30Min(checkTime);
         }
         if(isBlocked) {
           opt.disabled = true;
           opt.text += " (満)";
         }
         select.appendChild(opt);
      });
    }

    function add30Min(time) {
       let p = time.split(':');
       let h = parseInt(p[0]); let m = parseInt(p[1]);
       m += 30; if(m>=60) { m-=60; h++; }
       return h + ":" + (m<10?"0"+m:m);
    }

    function submitBooking() {
      let form = document.getElementById('bookingForm');
      if(!form.name.value || !form.menu.value || !form.date.value || !form.time.value) {
        alert("すべての項目を入力してください"); return;
      }
      
      document.getElementById('loading').style.display = 'block';
      document.getElementById('submitBtn').disabled = true;

      let slots = document.getElementById('menuSelect').options[document.getElementById('menuSelect').selectedIndex].getAttribute('data-slots');

      let postData = {
        action: "reserve",
        name: form.name.value,
        menu: form.menu.value,
        date: form.date.value,
        time: form.time.value,
        slots: slots,
        inquiry: form.note.value,
        via: "Web予約"
      };

      // GitHubからGASへPOST送信
      fetch(GAS_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(postData)
      })
      .then(response => response.json())
      .then(res => {
         if(res.result) {
             alert(res.result);
             location.reload();
         } else {
             alert("予約登録に失敗しました");
         }
         document.getElementById('loading').style.display = 'none';
         document.getElementById('submitBtn').disabled = false;
      })
      .catch(error => {
         console.error('Error:', error);
         alert("通信エラーが発生しました");
         document.getElementById('loading').style.display = 'none';
         document.getElementById('submitBtn').disabled = false;
      });
    }
  </script>
</body>
</html>
